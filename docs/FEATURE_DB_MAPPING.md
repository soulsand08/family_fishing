# 機能別：データベース技術活用まとめ

アプリの各機能で、どのデータベース技術がどのように使われているかの対応表です。

---

## 🚀 1. 短歌を交換する

- **使用技術**: **正規化、外部キー、トランザクション**
- **解説**:
  - **正規化**: 入力された短歌は、重複がないよう `users` テーブルと切り離された `tanka_pool` テーブルへ保存されます。
  - **外部キー**: 投稿時に「実在するユーザー ID か」を DB がチェックし、参照整合性を守ります。
  - **トランザクション**: 「自分の歌を保存」「相手の歌を取得」「相手の歌を削除」「交換履歴を記録」の全工程を一つにまとめ、失敗時にデータが消えるのを防いでいます。

## 📚 2. 統計を見る

- **使用技術**: **JOIN、SubQuery**
- **解説**:
  - **JOIN**: `tanka_pool` ⋈ `tanka_categories` ⋈ `categories` を結合し、ID ではなく「カテゴリ名」として表示します。
  - **SubQuery**: 各短歌が何回選ばれたかを、`exchange_history` テーブルをカウントする副問合せで算出し、ランキングを作成しています。

## 👤 マイ統計

- **使用技術**: **外部キー、JOIN**
- **解説**:
  - **外部キー**: セッション ID に紐づく `user_id` をキーにして、あなたに関連する履歴だけを抽出します。
  - **JOIN**: `users` テーブルと `exchange_history` を結合し、ユーザー名（セッション ID）と統計情報を一度に取得します。

---

## 💡 先生への一言まとめ（アピールポイント）

| 技術         | 本アプリでの役割                                               |
| :----------- | :------------------------------------------------------------- |
| **正規化**   | データを「短歌・ユーザー・カテゴリ」に美しく**整理**する。     |
| **外部キー** | 分けたデータ同士を「参照整合性」というヒモで安全に**つなぐ**。 |
| **JOIN**     | 分けたデータを、表示の瞬間に必要な形へ**復元**する。           |
| **SubQuery** | 全体の履歴から特定のデータを瞬時に**計算**して持ってくる。     |

> 「本システムは、UI のシンプルさとは裏腹に、内部ではリレーショナルデータベースの強力な機能（JOIN, SubQuery, Transaction）をフルに活用して、データの正確性と高度な集計を実現しています。」
