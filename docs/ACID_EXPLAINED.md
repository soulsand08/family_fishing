# データベースの ACID 特性：本アプリでの活用事例

データベース講義の最重要概念である**ACID 特性**が、このアプリの「短歌交換」という心臓部でどのように機能しているかを詳しく解説します。

---

## 1. Atomicity (原子性)

**「すべて実行されるか、全く実行されないか」**

- **本アプリでの例**: `models.py` の `record_exchange` 関数
- **仕組み**:
  1. 交換履歴を保存する (`INSERT`)
  2. 短歌の交換回数を 1 増やす (`UPDATE`)
- **活用**: この 2 つの処理はセットで行われます。もし途中でエラーが起きた場合、`commit()` が行われないため、DB の状態は「処理が始まる前」に完全に戻ります。「履歴だけ残って回数が増えない」といった不完全な状態を防いでいます。

## 2. Consistency (一貫性)

**「ルール（制約）を常に守り続ける」**

- **本アプリでの例**: **外部キー制約 (Foreign Key)**
- **仕組み**: `exchange_history` テーブルの `user_id` は必ず `users` テーブルに存在する ID でなければならない、というルールを DB が強制しています。
- **活用**: 「存在しないユーザーが短歌を交換した」という矛盾したデータが生まれるのを DB レベルで阻止し、データの正しさを常に保証しています。

## 3. Isolation (独立性)

**「同時実行しても互いに邪魔しない」**

- **本アプリでの例**: **同時多発的な短歌交換**
- **仕組み**: PostgreSQL の並行制御機能（MVCC など）が働いています。
- **活用**: A さんと B さんが同時に短歌を投稿・交換しても、DB 内部ではそれぞれの処理が独立して管理されます。一人の交換処理がもう一人のデータ読み取りを邪魔したり、同じ短歌を同時に二人が取得して不整合が起きるのを防いでいます。

## 4. Durability (永続性)

**「完了した処理は、停電しても消えない」**

- **本アプリでの例**: **Docker Volume による永続化**
- **仕組み**: `commit()` が完了した瞬間、PostgreSQL はディスク（WAL ログ）に内容を書き込みます。
- **活用**: たとえアプリがクラッシュしたり、PC の電源が突然切れたりしても、Docker を通じてホスト PC のディスクにデータが保存されているため、再起動後にデータが失われることはありません。

---

### 💡 先生へのアピールまとめ

「本アプリでは、データの整合性が最も重要視される『短歌交換』のフローにおいて、PostgreSQL の**ACID 特性**を最大限に活用しています。特に中間テーブルへの記録とカウントアップを一つのトランザクションにまとめることで**原子性**を担保し、外部キーによって**一貫性**を維持しています。」

このように説明すると、「DB の基礎理論を実務レベルで理解している」という非常に高い評価に繋がります。
