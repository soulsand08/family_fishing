# データベース概念と実装の関連性解説ガイド

本プロジェクトのデータベース構造を例に、**「正規化」「外部キー」「JOIN」「SubQuery」**がどのように連携してシステムを支えているかを解説します。

---

## 1. 正規化 (Normalization): データを整理して「分ける」

本アプリでは、**第 3 次正規化 (3NF)** を行い、データの重複を徹底的に排除しています。

- **実例**: 「短歌」と「カテゴリ」の関係。
- **なぜ分けるのか**: もし `tanka_pool` テーブルに直接 `category_name` （「春」など）を持たせると、同じカテゴリ名が何千回も保存され、名前を変えたいときに全レコードを更新しなければなりません（更新異常）。
- **構成**:
  - `tanka_pool`: 短歌の本文だけを持つ。
  - `categories`: カテゴリの名前と説明だけを持つ。
  - `tanka_categories`: どの短歌がどのカテゴリか、という**「関係」だけを持つ中間テーブル**。

---

## 2. 外部キー (Foreign Key): 分けたテーブルを「つなぐ」

正規化でバラバラにしたテーブル同士を、物理的なヒモでつなぐのが外部キーです。

- **実例**: `tanka_pool.user_id` は `users.user_id` を参照しています。
- **役割**:
  - **整合性の維持**: 存在しないユーザー ID を短歌に登録することを DB が拒否します。
  - **連動削除 (CASCADE)**: ユーザーが削除されたら、そのユーザーの交換履歴も自動で削除するように設定しています。
- **関係性**: 正規化で分かれたテーブル同士の**「論理的な親子関係」を DB レベルで保証**するのが外部キーです。

---

## 3. JOIN (結合): 分けたデータを「復元する」

正規化でバラバラにしたデータは、表示するときに一行にまとめる必要があります。

- **実例**: `get_tankas_by_category` 関数の SQL。
- **処理内容**:
  ```sql
  SELECT tp.content, c.name
  FROM tanka_pool tp
  INNER JOIN tanka_categories tc ON tp.id = tc.tanka_id
  INNER JOIN categories c ON tc.category_id = c.category_id
  WHERE c.name = '春';
  ```
- **関係性**: **外部キーという「ヒモ」を辿って、正規化で分かれた複数のテーブルから必要なパーツを集め、一つの結果（表）に再構成する**のが JOIN です。

---

## 4. SubQuery (副問合せ): 分けたデータで「計算する」

「つなげる(JOIN)」だけではなく、「そのデータを使って別の場所で計算した結果を持ってくる」のがサブクエリです。

- **実例**: `get_popular_tankas` 関数の SQL。
- **処理内容**:
  ```sql
  SELECT tp.content,
      (SELECT COUNT(*) FROM exchange_history eh WHERE eh.received_tanka_id = tp.id) as exchange_count
  FROM tanka_pool tp;
  ```
- **関係性**: 別の場所に正規化（分離）保存されている `exchange_history`（履歴）テーブルから、**特定のレコードに関連する集計結果だけをピンポイントで取ってきて、メインの結果に埋め込む**のがサブクエリです。

---

## 💡 まとめ：エンジニアリングの視点

| 概念         | アクション   | 本アプリでの役割                                 |
| :----------- | :----------- | :----------------------------------------------- |
| **正規化**   | **分ける**   | データの重複をなくし、効率的な管理を行う。       |
| **外部キー** | **つなぐ**   | テーブル間の関係を定義し、壊れないように守る。   |
| **JOIN**     | **復元する** | 分かれた情報を一つの画面表示用に組み立て直す。   |
| **SubQuery** | **計算する** | 分かれた情報を元に、複雑な統計や順位を算出する。 |

このように、**「綺麗に分けて(正規化)、安全につないで(外部キー)、賢く取り出す(JOIN/SubQuery)」**という流れが、本アプリの堅牢なデータ管理を実現しています。
