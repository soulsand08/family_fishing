# アプリケーションサーバー (Waitress) 実装報告書

大学の最終課題要件である「Web サーバー、アプリケーションサーバー、DB の構築と連結」を完全に満たすために実施した、Waitress の実装内容をまとめました。

---

## 1. 実装の背景

従来の構成では、Flask に内蔵されている「開発用サーバー」を使用していました。しかし、これはセキュリティや性能の観点から本番環境（デプロイ環境）での使用が推奨されておらず、要件にある「アプリケーションサーバー」としての役割を十分に果たしているとは言い難い状態でした。

そこで、Python 製のプロダクション品質 WSGI サーバーである **Waitress** を導入し、正式な 3 層構造を実現しました。

## 2. 具体的な実装内容

### ① ライブラリの導入

`requirements.txt` に `waitress` を追加し、インストールしました。

```text
waitress==3.0.0
```

### ② 本番用起動スクリプトの作成 (`server.py`)

Web ブラウザ等を介さず、純粋なアプリケーションサーバーとして起動するためのエントリーポイントを作成しました。

- **役割**: インフラ準備（Docker 起動）から DB 接続確認、そして Waitress によるサーバー起動までを一気通貫で行います。
- **コード**:
  ```python
  from waitress import serve
  from app import app
  # ...セットアップ処理...
  serve(app, host='0.0.0.0', port=5000)
  ```

### ③ デスクトップアプリの改修 (`desktop_app.py`)

デスクトップ版の起動ロジックも、Flask の開発用サーバーから Waitress に変更しました。

- **変更前**: `app.run(...)`
- **変更後**: `serve(app, ...)`
  これにより、デスクトップアプリとして配布した際も、内部で堅牢なサーバーが動作するようになりました。

## 3. 変更後のアーキテクチャ

この変更により、システムの構成は以下のように明確化されました。

| 層                           | コンポーネント      | 役割                           |
| ---------------------------- | ------------------- | ------------------------------ |
| **プレゼンテーション層**     | Browser / PyWebView | 画面表示、ユーザー入力         |
| **アプリケーションサーバー** | **Waitress**        | リクエストの受付、負荷分散     |
| **Web フレームワーク**       | Flask               | ルーティング、ビジネスロジック |
| **データ層**                 | PostgreSQL          | データの保存、整合性担保       |

## 4. 起動方法

### アプリケーションサーバー単体として起動する場合

```bash
python server.py
```

※ ログには `Serving on http://0.0.0.0:5000` と表示され、本番モードで動作します。

### デスクトップアプリとして起動する場合

```bash
python desktop_app.py
```

※ 内部で自動的に Waitress が立ち上がります。
