# プレゼンテーション用技術解説資料

## 匿名短歌交換アプリ：システムアーキテクチャと内部構造の詳解

この資料では、各コンポーネントが「どのような役割を担い、どのファイルでどのように動作しているか」という内部構造を詳説します。

---

### 1. フロントエンド：プレゼンテーション層

ユーザーインターフェースを提供し、バックエンドとのやり取りを制御します。

- **Jinja2 テンプレートエンジンの仕組み**
  - **関連ファイル**: `app/templates/*.html` (例: `home.html`, `submit.html`, `result.html`)
  - **役割**: サーバーサイドで HTML を動的に生成します。
  - **挙動**: `app/main.py` が DB から取得したデータを HTML 内の変数（例：`{{ received_tanka }}`）に注入し、完成した HTML をブラウザに送信します。
- **LocalStorage による受信履歴の保持**
  - **関連ファイル**: `app/static/js/main.js`
  - **役割**: ブラウザ側に「受信履歴」を永続化させます。
  - **挙動**: 交換成功時にバックエンドから返されたデータを JavaScript が受け取り、ブラウザの `LocalStorage` に保存・リスト表示します。サーバーに負荷をかけず履歴を管理する手法です。
- **PyWebView によるデスクトップ化**
  - **関連ファイル**: `desktop_app.py`
  - **役割**: Web 技術をデスクトップアプリの表示エンジンとして利用します。
  - **挙動**: ローカルで立ち上がった Flask サーバーの URL をウィンドウ内に描画します。バックエンドを別スレッドで同時起動する制御もここで行っています。

---

### 2. バックエンド：アプリケーション層

システムの「司令塔」として、データの加工と DB 操作を統括します。プロトコルレベルでは **WSGI (Web Server Gateway Interface)** という標準規格に準拠しています。

- **アプリケーションサーバー: Waitress**
  - **関連ファイル**: `server.py`
  - **役割**: Web サーバーと Flask アプリの間を取り持つ「アプリケーションサーバー」としての役割を担います。
  - **挙動**: 純粋な Python で書かれたプロダクション対応サーバーであり、高負荷時でも安定してリクエストを捌けるよう設計されています。開発用の `flask run` (app.run) ではなく、こちらを採用することで「デプロイ可能な構成」という要件を満たしています。
- **ルーティングとビジネスロジック: Flask**
  - **関連ファイル**: `app/main.py`
  - **役割**: URL と処理の紐付け（ルーティング）と、アプリのルール実行を行います。
  - **挙動**: ユーザーの入力を精査し、Waitress から渡されたリクエストに応じて関数を実行します。

* **データベース操作の抽象化**
  - **関連ファイル**: `app/models.py`
  - **役割**: 具体的な SQL クエリを隠蔽し、プログラムから扱いやすくします。
  - **挙動**: `psycopg2` を用いて、JOIN やサブクエリを含む複雑な SQL を実行し、Python のオブジェクト（リストや辞書）として結果を返します。
* **自動セットアップ機能**
  - **関連ファイル**: `app/main.py` (関数の定義), `desktop_app.py` (呼び出し)
  - **役割**: インフラ起動を自動化し、環境構築のミスを防止します。
  - **挙動**: `subprocess` で Docker の状態を確認し、未起動なら `docker-compose up` を自動実行します。

---

### 3. データベース：データ層

情報の永続化とデータの整合性を物理的に担保します。

- **データベース環境の定義**
  - **関連ファイル**: `docker-compose.yml`, `.env`
  - **役割**: コンテナの構成と接続情報の管理。
  - **挙動**: PostgreSQL のバージョン、ポート、パスワード等を一括定義し、どの環境でも同じ DB が立ち上がるようにします。
- **スキーマ設計と初期化**
  - **関連ファイル**: `scripts/init_db.py`
  - **役割**: テーブル構造の定義と初期マスタデータの投入。
  - **挙動**: 外部キー制約を含む DDL (Data Definition Language) を実行し、参照整合性のある強力なスキーマを構築します。
- **マイグレーション（構造更新）**
  - **関連ファイル**: `scripts/migrate_db.py`
  - **役割**: 既存データを保持したままテーブル構造を変更します。
  - **挙動**: `ALTER TABLE` を用い、運用中のデータベースに新しいカラム（`user_id` 等）を追加し、不整合を解消します。

---

### 4. まとめ：処理の全体フロー

1.  **起動**: `desktop_app.py` が `app/main.py` の自動セットアップを呼び出し、`docker-compose.yml` に基づき DB を起動。
2.  **投稿**: ユーザーが `submit.html` から投稿。`app/main.py` が入力を受け取る。
3.  **交換**: `app/models.py` が SQL を実行し、DB からランダムに短歌を抽出・更新。
4.  **表示**: `result.html` が生成され、`main.js` が履歴を記録して画面に表示。

このように、各ファイルが役割を分担することで、変更に強く、安定したシステムを実現しています。
