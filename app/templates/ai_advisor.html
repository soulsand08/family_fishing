{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="ai-advisor-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="advisor-header">
            <div class="advisor-icon">ğŸ¤–</div>
            <div class="advisor-info">
                <h2>AI æ­Œäººã«ç›¸è«‡ï¼ˆBetaï¼‰</h2>
                <p>ã‚ãªãŸã®å¿ƒã«å¯„ã‚Šæ·»ã„ã€çŸ­æ­Œã¥ãã‚Šã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚<br>
                <small>â€» ç¾åœ¨ã¯ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å‹•ä½œãƒ¢ãƒ¼ãƒ‰ã§ã™</small></p>
            </div>
            <a href="{{ url_for('home') }}" class="btn-home"> ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
        </div>

        <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
        <div class="chat-history" id="chatHistory">
            <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="message ai-message">
                <div class="message-content">
                    ã“ã‚“ã«ã¡ã¯ã€‚AIæ­Œäººã§ã™ã€‚<br>
                    ä»Šã®ã‚ãªãŸã®æ°—åˆ†ã‚„ã€è© ã¿ãŸã„æƒ…æ™¯ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚<br>
                    éå»ã®çŸ­æ­Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆ{{ pool_count }}é¦–ï¼‰ã‹ã‚‰ã€ãƒ’ãƒ³ãƒˆã‚’æ¢ã—ã¦ãã¾ã™ã€‚
                </div>
                <div class="message-time">Now</div>
            </div>
        </div>

        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea id="userInput" placeholder="ä¾‹ï¼šä»•äº‹ã§ç–²ã‚Œã¦ã€å°‘ã—å¯‚ã—ã„æ°—æŒã¡..." rows="2"></textarea>
                <button id="sendBtn" onclick="sendMessage()">
                    é€ä¿¡
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* AIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.ai-advisor-container {
    max-width: 600px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 70vh;
    min-height: 500px;
}

.advisor-header {
    background: #f8f9fa;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.advisor-icon {
    font-size: 2.5rem;
    background: #e9ecef;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.advisor-info h2 {
    font-size: 1.1rem;
    margin: 0;
    color: #333;
}

.advisor-info p {
    font-size: 0.8rem;
    margin: 4px 0 0;
    color: #666;
}

.chat-history {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    background: #fafafa;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
}

.message {
    display: flex;
    flex-direction: column;
    max-width: 80%;
    animation: fadeIn 0.3s ease;
}

.ai-message {
    align-self: flex-start;
}

.user-message {
    align-self: flex-end;
    align-items: flex-end;
}

.message-content {
    padding: 1rem 1.2rem;
    border-radius: 12px;
    font-size: 0.95rem;
    line-height: 1.6;
    position: relative;
    white-space: pre-wrap;
}

.ai-message .message-content {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-top-left-radius: 2px;
    color: #333;
}

.user-message .message-content {
    background: #7b6b5c; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ */
    color: #fff;
    border-top-right-radius: 2px;
}

.message-time {
    font-size: 0.7rem;
    color: #999;
    margin-top: 4px;
    padding: 0 4px;
}

.chat-input-area {
    padding: 1rem;
    background: #fff;
    border-top: 1px solid #eee;
}

.input-wrapper {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
}

#userInput {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 0.8rem;
    font-family: inherit;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
}

#userInput:focus {
    border-color: #7b6b5c;
}

#sendBtn {
    background: #7b6b5c;
    color: white;
    border: none;
    padding: 0 1.5rem;
    height: 50px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s;
}

#sendBtn:hover {
    background: #5d4e42;
}

#sendBtn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* å¼•ç”¨çŸ­æ­Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
.ref-tanka {
    margin: 10px 0;
    padding: 10px;
    background: #fdfdfd;
    border-left: 3px solid #7b6b5c;
    font-family: 'Yu Mincho', serif;
    font-style: italic;
    color: #555;
}

.btn-home {
    margin-left: auto;
    padding: 0.5rem 1rem;
    background: #e9ecef;
    color: #555;
    text-decoration: none;
    border-radius: 6px;
    font-size: 0.85rem;
    transition: background 0.2s;
}

.btn-home:hover {
    background: #dde2e6;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
async function sendMessage() {
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const history = document.getElementById('chatHistory');
    const message = input.value.trim();

    if (!message) return;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    appendMessage(message, 'user');
    input.value = '';
    
    // UIåˆ¶å¾¡
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.innerText = 'è€ƒãˆä¸­...';

    try {
        // APIå‘¼ã³å‡ºã—ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
        const response = await fetch('/api/ai-consult', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });

        const data = await response.json();
        
        // AIå¿œç­”è¡¨ç¤ºï¼ˆå°‘ã—é…å»¶ã•ã›ã¦ã€Œè€ƒãˆã¦ã„ã‚‹æ„Ÿã€ã‚’å‡ºã™ï¼‰
        setTimeout(() => {
            appendMessage(data.response, 'ai');
        }, 800);

    } catch (error) {
        appendMessage('ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚AIã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'ai');
    } finally {
        setTimeout(() => {
            input.disabled = false;
            sendBtn.disabled = false;
            sendBtn.innerText = 'é€ä¿¡';
            input.focus();
        }, 800);
    }
}

function appendMessage(text, type) {
    const history = document.getElementById('chatHistory');
    const div = document.createElement('div');
    div.className = `message ${type}-message`;
    
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    div.innerHTML = `
        <div class="message-content">${text}</div>
        <div class="message-time">${time}</div>
    `;
    
    history.appendChild(div);
    history.scrollTop = history.scrollHeight;
}

// Enteré€ä¿¡ï¼ˆShift+Enterã¯æ”¹è¡Œï¼‰
document.getElementById('userInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
</script>
{% endblock %}
